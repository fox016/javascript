<!DOCTYPE HTML>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"> 
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Grenze+Gotisch:wght@300;600;900&display=swap" rel="stylesheet">

  <!-- BEGIN STYLE-->
  <style type='text/css'>
  body
  {
    background-image: radial-gradient(#7CAFCE 50%, #444);
    background-repeat: no-repeat;
    background-size: auto;
  }
  .page
  {
    text-align:center;
  }
  h1
  {
    font-size:48px;
    font-family:"Grenze Gotisch",serif;
    color: #c8965a;
    text-shadow: 2px 3px 4px #282828;
  }
  #playerCountDiv
  {
    display:flex;
    justify-content:center;
    align-items:center;
  }
  #playerCount
  {
    font-size:144px;
    font-family:"Grenze Gotisch",serif;
    color: #F9E230;
    text-shadow: 2px 3px 4px #282828;
    margin-bottom:30px;
  }
  #playerCountDiv button
  {
    background:none;
    border:none;
    font-size:48px;
    font-family:serif;
    color: #e6e6e6;
    text-shadow: 2px 3px 4px #282828;
    font-weight:900;
    cursor:pointer;
  }
  .nav
  {
    display:flex;
    justify-content:space-between;
    width:100%;
    margin:0px auto;
  }
  .nav button
  {
    background:none;
    border:none;
    font-size:36px;
    color: #e6e6e6;
    font-family:"Grenze Gotisch",serif;
    text-shadow: 2px 3px 4px #282828;
    font-weight:900;
    cursor:pointer;
  }
  input.playerName
  {
    display:block;
    margin:0px auto;
    height:60px;
    width:calc(100% - 80px);
    margin-bottom:20px;
    border:none;
    background:#ffffff80;
    font-size:48px;
    border-bottom:2px solid #666;
    color:#f9e230;
    font-family:"Grenze Gotisch",serif;
    text-shadow: 2px 3px 4px #282828;
  }
  input.playerName.error
  {
    border:2px solid red;
  }
  .player
  {
    padding:0 20px;
    border:2px solid black;
    border-radius:20px;
    background:#ffffff80;
    margin:20px;
  }
  .playerHeader
  {
    display:flex;
    justify-content:space-between;
    font-size:48px;
    font-family:"Grenze Gotisch",serif;
    text-shadow: 2px 3px 4px #282828;
    color:#f9e230;
  }
  .playerHistory
  {
    display:none;
  }
  .historyItem
  {
    display: flex;
    align-items: center;
    margin-bottom: 20px;
    background-color: #fff8;
    padding: 10px;
    border-radius: 10px;
  }
  .historyRound
  {
    font-size:48px;
    font-family:"Grenze Gotisch",serif;
    text-shadow: 2px 3px 4px #282828;
    color: #c8965a;
    font-weight:900;
    margin-right:15px;
  }
  .recordTable th
  {
    text-align:left;
    font-weight:normal;
    color:#666;
    font-family:sans-serif;
  }
  .recordTable td
  {
    font-size:1.2em;
    font-family:sans-serif;
    padding-right:15px;
    font-weight:bold;
  }
  .recordTable input
  {
    width:40px;
  }
  .saveBtn
  {
    background-color:#e6e6e6;
    color:#000;
    border-radius:0;
    height:30px;
    border:1px solid #000;
  }
  </style>
  <!-- END STYLE-->

  <!-- BEGIN SCRIPT -->
  <script type='text/javascript'>

  var current_page = 0;
  var players = [];

  $(document).ready(function()
  {
    $(window).resize(resize);

    setPage();

    $("#addPlayer").click(function()
    {
      let count = parseInt($("#playerCount").text());
      if(count < 6)
        $("#playerCount").html(count+1);
    });
    $("#removePlayer").click(function()
    {
      let count = parseInt($("#playerCount").text());
      if(count > 2)
        $("#playerCount").html(count-1);
    });
    $(".playerBtn").bind('touchmove', function(e) {
      e.preventDefault();
      $(this).click();
    });
    $(".playerBtn").bind('touchend', function(e) {
      e.preventDefault();
      $(this).click();
    });
    $(".nextBtn").click(function() { setPage(current_page+1); });
    $(".prevBtn").click(function() { setPage(current_page-1); });
  });

  function setPage(page)
  {
    // Pre-loading logic
    if(typeof page !== "number")
      page = current_page+1;
    if(current_page == 2)
    {
      let valid = true;
      let names = [];
      $(".playerName").each(function()
      {
        let name = $.trim($(this).val());
        if(name == "" || names.includes(name))
        {
          $(this).addClass("error");
          valid = false;
        }
        else
        {
          $(this).removeClass("error");
          names.push(name);
        }
      });
      if(!valid && page > current_page)
        return;
    }

    // Loading logic
    if(page == 2)
    {
      let nameCount = $(".playerName").length;
      let count = parseInt($("#playerCount").text());
      let html = "";
      if(nameCount < count)
      {
        for(i = nameCount; i < count; i++)
        {
          $("#playerNameDiv").append("<input class='playerName' type='text' />");
        }
      }
      else if(nameCount > count)
      {
        for(i = 0; i < nameCount - count; i++)
          $("#playerNameDiv .playerName:last-child").remove();
      }
    }
    else if(page == 3)
    {
      players = [];
      $(".playerName").each(function()
      {
        players.push({
          name: $(this).val(),
          score: 0,
          history: [],
        });
      });
      refreshPlayers();
    }

    // Post-loading logic
    $(".page").hide();
    $("#page"+page).show();
    current_page = page;
    resize();
  }

  function refreshPlayers()
  {
    let html = "";
    for(let i = 0; i < players.length; i++)
    {
      let p = players[i];
      html += "" +
        "<div class='player'>" +
          "<div class='playerHeader'>" +
            "<div class='playerNameDisplay'>" + p.name + "</div>" +
            "<div class='playerScoreDisplay'>" + p.score + "</div>" +
          "</div>" +
          "<div class='playerHistory'>" +
            getHistoryHtml(p.history) +
          "</div>" +
        "</div>";
    }
    $("#players").html(html).ready(function()
    {
      $(".playerHeader").unbind('click').click(function()
      {
        let player = $(this).closest(".player");
        if($(".playerHistory", player).is(":visible"))
        {
          $(".playerHistory").hide();
        }
        else
        {
          $(".playerHistory").hide();
          $(".playerHistory", player).show();
        }
        resize();
      });
      $(".recordTable input").unbind('change').change(function()
      {
        let table = $(this).closest(".recordTable");
        let s = getRoundScore({
          bid: $(".bidInput", table).val(),
          actual: $(".actualInput", table).val(),
          bonus: $(".bonusInput", table).val(),
          round: $(".historyRound", $(table).closest(".historyItem")).html(),
        });
        $(".currentRoundScore", table).html(s);
        if(s === "")
          $(".currentRoundTotal", table).html("");
        else
        {
          let total = parseInt($(".playerScoreDisplay", $(table).closest(".player")).html());
          $(".currentRoundTotal", table).html(parseInt(s)+total);
        }
      });
      $(".saveBtn").unbind('click').click(function()
      {
        let table = $(this).closest(".recordTable");
        let player = getPlayerByName($(".playerNameDisplay", $(this).closest(".player")).html());
        player.score = parseInt($(".currentRoundTotal", table).html());
        player.history.push({
          bid: $(".bidInput", table).val(),
          actual: $(".actualInput", table).val(),
          bonus: $(".bonusInput", table).val(),
          round: $(".historyRound", $(table).closest(".historyItem")).html(),
        });
        refreshPlayers();
      });
    });
    resize();
  }

  function getHistoryHtml(history)
  {
    let html = "";
    if(history.length < 10)
    {
      html += "" +
        "<div class='historyItem'>" +
          "<div class='historyRound'>" + (history.length+1) + "</div>" +
          "<div class='historyRecord'>" +
            "<table class='recordTable'>" +
              "<tbody>" +
                "<tr>" +
                  "<th>Bid</th>" +
                  "<td><input type='number' inputmode='numeric' pattern='[0-9]*' size='2' class='bidInput' /></td>" +
                  "<th>Score</th>" +
                  "<td class='currentRoundScore'></td>" +
                "</tr>" +
                "<tr>" +
                  "<th>Actual</th>" +
                  "<td><input type='number' inputmode='numeric' pattern='[0-9]*' size='2' class='actualInput' /></td>" +
                  "<th>Total</th>" +
                  "<td class='currentRoundTotal'></td>" +
                "</tr>" +
                "<tr>" +
                  "<th>Bonus</th>" +
                  "<td><input type='number' inputmode='numeric' pattern='[0-9]*' size='2' class='bonusInput' /></td>" +
                  "<td colspan=2><button class='saveBtn'>Save Round</button></td>" +
                "</tr>" +
              "</tbody>" +
            "</table>" +
          "</div>" +
        "</div>";
    }
    let total = 0;
    for(let i = 0; i < history.length; i++)
    {
      let h = history[i];
      let score = getRoundScore(h);
      total += score;
      html += "" +
        "<div class='historyItem'>" +
          "<div class='historyRound'>" + h.round + "</div>" +
          "<div class='historyRecord'>" +
            "<table class='recordTable'>" +
              "<tbody>" +
                "<tr>" +
                  "<th>Bid</th>" +
                  "<td>" + h.bid + "</td>" +
                  "<th>Score</th>" +
                  "<td>" + score + "</td>" +
                "</tr>" +
                "<tr>" +
                  "<th>Actual</th>" +
                  "<td>" + h.actual + "</td>" +
                  "<th>Total</th>" +
                  "<td>" + total + "</td>" +
                "</tr>" +
                "<tr>" +
                  "<th>Bonus</th>" +
                  "<td>" + h.bonus + "</td>" +
                  "<td></td>" +
                  "<td></td>" +
                "</tr>" +
              "</tbody>" +
            "</table>" +
          "</div>" +
        "</div>";
    }
    return html;
  }

  function getRoundScore(round)
  {
    let score = 0;
    console.log(round);
    if(round.bid === "" || round.actual === "")
      return "";
    round.bid = parseInt(round.bid);
    round.actual = parseInt(round.actual);
    round.bonus = parseInt(round.bonus);
    if(isNaN(round.bonus))
      round.bonus = 0;
    round.round = parseInt(round.round);
    if(round.bid == round.actual)
    {
      if(round.bid == 0)
        score = round.round * 10 + round.bonus;
      else
        score = round.actual * 20 + round.bonus;
    }
    else
    {
      if(round.bid == 0)
        score = round.round * -10;
      else
        score = -10 * Math.abs(round.bid - round.actual);
    }
    return score;
  }

  function getPlayerByName(name)
  {
    for(let i = 0; i < players.length; i++)
    {
      if(players[i].name == name)
        return players[i];
    }
    return null;
  }

  function resize()
  {
    let width = $(window).width() + "px";
    let height = Math.max(document.body.clientHeight+30, $(window).height()) + "px";
    $('body').css('background-size', width + " " + height);
    $("#skullKingImg").ready(function(){
      $("#skullKingImg").css({
        top: parseInt(height.replace("px", ""))/2-($("#skullKingImg").height()/2) + "px",
        left: parseInt(width.replace("px", ""))/2-($("#skullKingImg").width()/2) + "px"
      });
    });
  }

  </script>
  <!-- END SCRIPT -->

</head>
<body>

<img id="skullKingImg" style="position:absolute; top:0; z-index:-1; opacity:0.2; width:250px; height:356.45px;" alt="Skull King" data-type="image" itemprop="image" src="https://static.wixstatic.com/media/524f08_78aebdb85f7740ca95128df99881b813~mv2_d_1456_2076_s_2.png">

<div class='page' id='page1'>
  <h1>How many players?</h1>
  <div id='playerCountDiv'>
    <div id='playerCount'>2</div>
    <div>
      <button class='playerBtn' id='addPlayer'>&uarr;</button><br/>
      <button class='playerBtn' id='removePlayer'>&darr;</button>
    </div>
  </div>
  <div class='nav'>
    <div></div>
    <button class='nextBtn'>Next &rarr;</button>
    <div></div>
  </div>
</div>

<div class='page' id='page2'>
  <h1>Enter player names:</h1>
  <div id='playerNameDiv'>
  </div>
  <div class='nav'>
    <button class='prevBtn'>&larr;</button>
    <button class='nextBtn'>&rarr;</button>
  </div>
</div>

<div class='page' id='page3'>
  <div id='players'>
  </div>
</div>

</body>
</html>
